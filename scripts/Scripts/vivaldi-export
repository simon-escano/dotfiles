#!/bin/bash
# vivaldi-export — Export Vivaldi UI settings (toolbars, themes, flags, panels, etc.)
# Extracts only the relevant keys from Preferences and Local State
# Saves to ~/dotfiles/vivaldi/vivaldi-settings.json

DOTFILES_DIR="$HOME/dotfiles"
VIVALDI_DIR="$HOME/.config/vivaldi"
PREFS_FILE="$VIVALDI_DIR/Default/Preferences"
LOCAL_STATE="$VIVALDI_DIR/Local State"
OUTPUT_FILE="$DOTFILES_DIR/vivaldi/vivaldi-settings.json"

if [[ ! -f "$PREFS_FILE" ]]; then
    echo "❌ Vivaldi Preferences not found at $PREFS_FILE"
    exit 1
fi

python3 -c "
import json, sys

output = {}

# Extract relevant keys from Preferences
try:
    with open('$PREFS_FILE', 'r') as f:
        prefs = json.load(f)

    vivaldi_keys = [
        'actions', 'address_bar', 'appearance', 'bookmarks', 'calendar',
        'chained_commands', 'context_dialogs', 'dashboard', 'downloads',
        'language_at_install', 'list', 'panels', 'pip_placement', 'popups',
        'privacy', 'sessions', 'settings', 'startup', 'system', 'tabs',
        'theme', 'themes', 'toolbars', 'translate', 'welcome', 'windows'
    ]

    if 'vivaldi' in prefs:
        output['vivaldi'] = {k: prefs['vivaldi'][k] for k in vivaldi_keys if k in prefs['vivaldi']}

    # Also grab pinned_tabs and saved_tab_groups if present
    for key in ['pinned_tabs', 'saved_tab_groups']:
        if key in prefs:
            output[key] = prefs[key]

except Exception as e:
    print(f'Warning: Could not read Preferences: {e}', file=sys.stderr)

# Extract experimental flags from Local State
try:
    with open('$LOCAL_STATE', 'r') as f:
        local_state = json.load(f)

    if 'browser' in local_state and 'enabled_labs_experiments' in local_state['browser']:
        output['enabled_labs_experiments'] = local_state['browser']['enabled_labs_experiments']

except Exception as e:
    print(f'Warning: Could not read Local State: {e}', file=sys.stderr)

# Write output
with open('$OUTPUT_FILE', 'w') as f:
    json.dump(output, f, indent=2)

print(f'✅ Exported {len(output)} sections to vivaldi-settings.json')
"
